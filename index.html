
<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ç¨å‹™çª“å£ãƒ­ãƒ¼ãƒ—ãƒ¬ï¼ˆç„¡æ–™ãƒ»ã‚­ãƒ¼ä¸è¦ãƒ»ãƒ–ãƒ©ã‚¦ã‚¶ã ã‘ï¼‰</title>
<style>
  body{font-family:system-ui,'Noto Sans JP',sans-serif;margin:24px}
  .wrap{display:grid;grid-template-columns:320px 1fr;gap:24px;align-items:start}
  .panel{padding:16px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,.03)}
  .bubble{padding:10px 12px;border-radius:12px;margin:8px 0;max-width:640px}
  .user{background:#e7f5ff}.agent{background:#f1f3f5}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .pill{padding:6px 12px;border-radius:999px;background:#eef}.small{font-size:12px;color:#555}
  input[type=text],select{flex:1;padding:10px;border:1px solid #ccc;border-radius:8px}
  button{padding:10px 16px;border:0;border-radius:8px;cursor:pointer;background:#2563eb;color:#fff}
  #avatarStage{width:300px;height:300px;position:relative;border-radius:16px;overflow:hidden;background:#EAF4FF}
  #avatarStage img{position:absolute;inset:0}
  .mouth{position:absolute;inset:0;display:none}.visible{display:block}
  audio{display:block;margin:8px 0;width:100%}
  pre{background:#f8f9fa;padding:12px;border-radius:8px;overflow:auto;max-height:240px}
</style>
</head>
<body>
<h1>ç¨å‹™çª“å£ãƒ­ãƒ¼ãƒ—ãƒ¬ï¼ˆç„¡æ–™ãƒ»ã‚­ãƒ¼ä¸è¦ãƒ»ãƒ–ãƒ©ã‚¦ã‚¶ã ã‘ï¼‰</h1>
<p class="pill small">éŸ³å£°èªè­˜/åˆæˆã¯ãƒ–ãƒ©ã‚¦ã‚¶ã® Web Speech API ã‚’ä½¿ç”¨ï¼ˆChromeæ¨å¥¨ï¼‰ã€‚</p>

<div class="wrap">
  <div class="panel">
    <div id="avatarStage">
      <img src="./assets/avatar/base.svg"/>
      <img class="mouth visible" id="mouthClosed" src="./assets/avatar/mouth_closed.svg"/>
      <img class="mouth" id="mouthOpen" src="./assets/avatar/mouth_open.svg"/>
      <img class="mouth" id="mouthA" src="./assets/avatar/mouth_a.svg"/>
      <img class="mouth" id="mouthI" src="./assets/avatar/mouth_i.svg"/>
      <img class="mouth" id="mouthU" src="./assets/avatar/mouth_u.svg"/>
      <img class="mouth" id="mouthO" src="./assets/avatar/mouth_o.svg"/>
    </div>
    <audio id="player" controls></audio>
    <div class="row" style="margin-top:8px;">
      <button id="rec">ğŸ™ï¸ é•·æŠ¼ã—ã§éŒ²éŸ³</button>
      <select id="scenario"></select>
    </div>
    <p id="state" class="small">state: start</p>
  </div>

  <div class="panel">
    <div id="chat"></div>
    <div class="row" style="margin-top:8px;">
      <input id="input" type="text" placeholder="ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰ã‚ãªãŸã®ã‚»ãƒªãƒ•â€¦"/>
      <button id="send">é€ä¿¡</button>
      <button id="scoreBtn" style="background:#0ea5e9;">æ¡ç‚¹</button>
    </div>
    <h3>æ¡ç‚¹çµæœ</h3>
    <pre id="result"></pre>
  </div>
</div>

<script>
// ------------------ Data loading ------------------
let SCENARIOS = [];
let RUBRIC = {};
(async () => {
  SCENARIOS = await (await fetch('./scenarios_tax.json')).json();
  RUBRIC = await (await fetch('./rubric_tax.json')).json();
  const sel = document.getElementById('scenario');
  SCENARIOS.scenarios.forEach(s => {
    const o = document.createElement('option');
    o.value = s.id; o.textContent = s.title; sel.appendChild(o);
  });
})();

// ------------------ UI helpers ------------------
const chat = document.getElementById('chat');
function addBubble(who, text){
  const div = document.createElement('div');
  div.className = 'bubble ' + (who === 'user' ? 'user' : 'agent');
  div.textContent = (who === 'user' ? 'ã‚ãªãŸ: ' : 'æ¥åºè€…: ') + text;
  chat.appendChild(div); chat.scrollTop = chat.scrollHeight;
}
function setMouth(id){
  document.querySelectorAll('.mouth').forEach(el=>el.classList.remove('visible'));
  const el = document.getElementById(id); if(el) el.classList.add('visible');
}
const player = document.getElementById('player');
player.addEventListener('play', ()=>{
  setMouth('mouthOpen'); let toggle=true;
  const iv=setInterval(()=>{ setMouth(toggle?'mouthOpen':'mouthClosed'); toggle=!toggle; },120);
  const stop=()=>{ clearInterval(iv); setMouth('mouthClosed'); player.removeEventListener('pause',stop); player.removeEventListener('ended',stop); };
  player.addEventListener('pause',stop); player.addEventListener('ended',stop);
});

// ------------------ Conversation engine (rule-based) ------------------
let state = 'start';
let convo = [];
document.getElementById('state').textContent = 'state: ' + state;

function heuristicsReply(userText, scenarioId){
  // Simple templates based on keywords and state
  const t = (userText||'').toLowerCase();
  const s = SCENARIOS.scenarios.find(x=>x.id===scenarioId) || SCENARIOS.scenarios[0];
  const H = s?.hints || [];

  if(state==='start'){
    if(/(ä½æ°‘ç¨|ç´ä»˜|è¨¼æ˜|å›ºå®šè³‡ç”£|è»½è‡ªå‹•è»Š|è¿”é‡‘|é‚„ä»˜)/.test(t)){
      return "ã”æ¥åºã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ã¾ãšã”ç”¨ä»¶ã‚’è©³ã—ãæ•™ãˆã¦ãã ã•ã„ã€‚";
    }
    return "ã“ã‚“ã«ã¡ã¯ã€‚ã”ç”¨ä»¶ã‚’ãŠèã‹ã›ãã ã•ã„ã€‚";
  }
  if(state==='id_check'){
    if(/(å…è¨±|èº«åˆ†è¨¼|ãƒã‚¤ãƒŠ|åœ¨ç•™|ä¿é™ºè¨¼)/.test(t)){
      return "ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚åç¾©ã¨ç”Ÿå¹´æœˆæ—¥ã€ä½æ‰€ã‚‚ã‚ã‚ã›ã¦ç¢ºèªã—ã¾ã™ã€‚";
    }
    return "ã¾ãšæœ¬äººç¢ºèªã®ãŸã‚ã€èº«åˆ†è¨¼ã®ã”æç¤ºã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚";
  }
  if(state==='doc_check'){
    if(/(åˆ†ç´|é‚„ä»˜|å……å½“|è¨¼æ˜|å†ç™ºè¡Œ|åç¾©|å»ƒè»Š|è©•ä¾¡|å¯©æŸ»|ç”³å‡º)/.test(t)){
      return "æ‰‹æ•°æ–™ã‚„å—ä»˜æ™‚é–“ã‚’å«ã‚ã€å¿…è¦æ›¸é¡ã¨æ‰‹é †ã‚’ã”æ¡ˆå†…ã—ã¾ã™ã€‚ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‚„ã‚³ãƒ³ãƒ“ãƒ‹ã®ä»£æ›¿ã‚‚é¸ã¹ã¾ã™ã€‚";
    }
    return (H[1] || "å¿…è¦æ›¸é¡ãƒ»æ‰‹æ•°æ–™ãƒ»å—ä»˜æ™‚é–“ã‚’ã”æ¡ˆå†…ã—ã¾ã™ã€‚");
  }
  if(state==='close'){
    if(/(å¤§ä¸ˆå¤«|ã‚ã‹ã£ãŸ|ã‚ã‚ŠãŒã¨ã†|åŠ©ã‹ã‚‹)/.test(t)){
      return "æœ¬æ—¥ã®å†…å®¹ã¯ä»¥ä¸Šã§ã™ã€‚ã”ä¸æ˜ç‚¹ãŒã‚ã‚Œã°ãŠçŸ¥ã‚‰ã›ãã ã•ã„ã€‚ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚";
    }
    return "ã“ã“ã¾ã§ã§ã”ä¸æ˜ç‚¹ã¯ã‚ã‚Šã¾ã›ã‚“ã‹ã€‚æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç¢ºèªã—ã¦çµ‚äº†ã—ã¾ã™ã€‚";
  }
  return "ç¢ºèªã—ã¾ã™ã€‚å°‘ã€…ãŠå¾…ã¡ãã ã•ã„ã€‚";
}

function nextState(userText){
  const t = (userText||'').toLowerCase();
  if(state==='start' && /(ä½æ°‘ç¨|ç´ä»˜|è¨¼æ˜|å›ºå®šè³‡ç”£|è»½è‡ªå‹•è»Š|è¿”é‡‘|é‚„ä»˜|ãã ã•ã„|æ¬²ã—ã„|æ‰‹ç¶šã)/.test(t)) return 'id_check';
  if(state==='id_check' && /(å…è¨±|èº«åˆ†è¨¼|ãƒã‚¤ãƒŠ|åœ¨ç•™|ä¿é™ºè¨¼|æç¤º)/.test(t)) return 'doc_check';
  if(state==='doc_check' && /(æ‰‹æ•°æ–™|å—ä»˜æ™‚é–“|å¿…è¦|æ›¸é¡|ã‚ªãƒ³ãƒ©ã‚¤ãƒ³|ã‚³ãƒ³ãƒ“ãƒ‹|åˆ†ç´|é‚„ä»˜|å……å½“|äºˆç´„)/.test(t)) return 'close';
  return state;
}

// ------------------ speech (free, browser) ------------------
const synth = window.speechSynthesis;
function speakJa(text){
  const uttr = new SpeechSynthesisUtterance(text);
  uttr.lang = 'ja-JP';
  uttr.rate = 1.0;
  const voices = synth.getVoices();
  const ja = voices.find(v=>/ja-JP/.test(v.lang));
  if(ja) uttr.voice = ja;
  uttr.onstart = ()=>{ player.src = ''; player.pause(); /* visual only */ };
  synth.speak(uttr);
}

let recognition;
function ensureRecognition(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR) { alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ï¼ˆChromeæ¨å¥¨ï¼‰'); return null; }
  const r = new SR();
  r.lang = 'ja-JP'; r.interimResults = false; r.maxAlternatives = 1;
  return r;
}

// record button
const recBtn = document.getElementById('rec');
recBtn.onmousedown = () => {
  recognition = ensureRecognition();
  if(!recognition) return;
  recognition.start();
  recBtn.textContent = "ğŸ™ï¸ éŒ²éŸ³ä¸­â€¦ï¼ˆé›¢ã™ã¨é€ä¿¡ï¼‰";
  recognition.onresult = (e)=>{
    const text = e.results[0][0].transcript;
    addBubble('user', text); convo.push({who:'user', text});
    const rep = heuristicsReply(text, document.getElementById('scenario').value);
    state = nextState(text); document.getElementById('state').textContent = 'state: ' + state;
    addBubble('agent', rep); convo.push({who:'agent', text: rep});
    speakJa(rep);
  };
  recognition.onerror = ()=>{ recBtn.textContent = "ğŸ™ï¸ é•·æŠ¼ã—ã§éŒ²éŸ³"; };
};
recBtn.onmouseup = () => { try{ recognition && recognition.stop(); }catch(e){} recBtn.textContent = "ğŸ™ï¸ é•·æŠ¼ã—ã§éŒ²éŸ³"; };

// text debug
const input = document.getElementById('input');
document.getElementById('send').onclick = () => {
  const text = input.value.trim(); if(!text) return; input.value='';
  addBubble('user', text); convo.push({who:'user', text});
  const rep = heuristicsReply(text, document.getElementById('scenario').value);
  state = nextState(text); document.getElementById('state').textContent = 'state: ' + state;
  addBubble('agent', rep); convo.push({who:'agent', text: rep});
  speakJa(rep);
};

// ------------------ scoring (rule-based only) ------------------
function scoreConversation(convo, rubric){
  const userAll = convo.filter(t=>t.who==='user').map(t=>t.text).join('\n');
  let scoreTotal = 0, weightSum = 0, sub = {}, improvements = [];
  for(const [key, rule] of Object.entries(rubric)){
    const must = rule.must||[]; let hit=0;
    must.forEach(pat => { if(new RegExp(pat).test(userAll)) hit++; });
    const ratio = hit / Math.max(1, must.length);
    const subScore = 1 + ratio * 4; // 1-5
    sub[key] = +(subScore.toFixed(2));
    scoreTotal += subScore * (rule.weight||1);
    weightSum += (rule.weight||1);
    if(ratio<1) improvements.push(`${rule.name}: è¦ä»¶ã‚’æº€ãŸã™ç™ºè©±ã‚’å¢—ã‚„ã—ã¾ã—ã‚‡ã†`);
  }
  const total100 = +( (scoreTotal / (5*weightSum) * 100).toFixed(1) );
  return { total_score: total100, sub_scores: sub, improvements: improvements.slice(0,5) };
}

document.getElementById('scoreBtn').onclick = async () => {
  const r = scoreConversation(convo, RUBRIC);
  document.getElementById('result').textContent = JSON.stringify(r, null, 2);
};
</script>
</body>
</html>
